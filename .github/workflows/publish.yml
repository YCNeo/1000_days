name: Publish 1000-Day Site

on:
  workflow_dispatch:
    inputs:
      force_deploy:
        description: "Force deploy (ignore anniversary date)?"
        required: false
        type: boolean
        default: false
  schedule:
    - cron: "0 16 * * *" # daily 16:00 UTC = 00:00 Asia/Taipei

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

env:
  ANNIVERSARY_DATE: "2025-07-18"
  TIMEZONE: "Asia/Taipei"

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check_date.outputs.deploy }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Check anniversary date
        id: check_date
        run: |
          TODAY=$(TZ=${{ env.TIMEZONE }} date +%F)
          echo "Today in ${{ env.TIMEZONE }}: $TODAY"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.force_deploy }}" == "true" ]]; then
            echo "Force deploy requested."
            echo "deploy=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          TARGET="${{ env.ANNIVERSARY_DATE }}"
          if [[ "$TODAY" < "$TARGET" ]]; then
            echo "Not yet anniversary ($TODAY < $TARGET). Skipping build."
            echo "deploy=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "Anniversary reached! Proceeding to upload artifact."
          echo "deploy=true" >> $GITHUB_OUTPUT

      - name: Upload site artifact
        if: steps.check_date.outputs.deploy == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./site

  deploy:
    if: needs.build.outputs.should_deploy == 'true'
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
